<!DOCTYPE html>
<html>
	<head>
		<link href="https://fonts.googleapis.com/css2?family=Blinker:wght@300;600&display=swap" rel="stylesheet">
		<title>BosBash.io | Waiting Room</title>
		<style>
			html, body {
				height: 100%;
				font-family: 'Blinker', sans-serif;
				color: white;
				text-align: center;
			}

			body { 
				margin: 0;
			}

			canvas {
				width: 100%;
				height: 100%;
			}

			#canvasContainer {
				position: absolute;
				left: 0;
				top: 0;
				width: 100%;
				height: 100%;
			}

			#chat {
				position: absolute;
				left: 0;
				bottom: 0;
				padding: 10px;
			}

			.waitingText {
				font-size: 2em;
				text-shadow: 0px 3px rgba(0,0,0,0.5);
			}

			input {
				height: 40px;
				width: 300px;

				padding: 4px 8px;
				box-sizing: border-box;

				border: none;
				background-color: white;
				box-shadow: 0px 3px rgba(0,0,0,0.25);

				font-size: 20px;
				font-family: 'Blinker', sans-serif;
			}

			.message:nth-child(even) {
				background-color: rgba(50,50,60,0.8);
			}

			.message {
				float: right;
				height: 26px;
				width: 300px;
				padding: 4px 8px;
				box-sizing: border-box;
				text-align: left;
				background-color: rgba(40,40,50,0.8);
			}
			
			#messages {
				opacity: 0.4;
				display: flex;
				flex-direction: column-reverse;
				width: 300px;
				height: 100px;
				overflow-x: hidden;
				overflow-y: overlay;
				transition: 0.5s;
			}

			#chat:hover #messages {
				height: 500px;
				opacity: 1;
			}
			
			#messages::-webkit-scrollbar {
				width: 10px;
			}

			::-webkit-scrollbar-track {
				background: rgba(50,50,50,0.5);
			}

			::-webkit-scrollbar-thumb {
				background: rgba(255,255,255,0.8);
			}
		</style>
	</head>
	<body>
		<canvas id="mainCanvas"></canvas>
		<div id="canvasContainer"></div>
		<div id="chat">
			<div id="messages">

			</div>
			<input id="chatMessage" placeholder="Send Message">
		</div>

		<script>
			if(!(localStorage.getItem('nickname') && localStorage.getItem('skin'))) {
				window.location = '/join/' + location.pathname.substr(1);
			}
		</script>

		<script src="/socket.io/socket.io.js"></script>
		<script src="https://code.jquery.com/jquery-1.11.1.js"></script>
		<script>
			var canvasContainer = document.getElementById('canvasContainer');
			var canvas = document.getElementById('mainCanvas');
			var ctx = canvas.getContext('2d');

			canvas.width = window.innerWidth;
			canvas.height = window.innerHeight;
			window.addEventListener('resize', function() {
				canvas.width = window.innerWidth;
				canvas.height = window.innerHeight;
			})
		</script>
		<script>
			var chatMessages = document.getElementById('messages');
			var chatMessage = document.getElementById('chatMessage');
			var messages = [];
			var socket = io({transports: ['websocket']});
			socket.emit('registerPlayer', {
				room: location.pathname.substr(1),
				nickname: localStorage.getItem('nickname'),
				skin: localStorage.getItem('skin')
			});

			var room = {
				players: {},
				min: 0,
				max: 0
			};
			socket.on('updateRoom', function(rm) {
				Object.keys(rm.players).forEach(function(id) {
					let dataURL = rm.players[id].skin;
					let skin = new Image;
					skin.src = dataURL;

					rm.players[id].skin = skin;
				})
				room = rm;
			});

			chatMessage.addEventListener('keyup', function(e) {
				if(e.keyCode == 13) {
					if(chatMessage.value != "") {
						socket.emit('message', chatMessage.value);
						chatMessage.value = "";
					}
				}
			})

			chat.addEventListener('mouseleave', function(e) {
				chatMessages.scrollTop = chatMessages.scrollHeight;
			})

			socket.on('message', function(msg) {
				let message = document.createElement('div');
				message.className = 'message';
				let name = document.createElement('b');
				name.style.color = room.players[msg.id].color;
				name.innerText = room.players[msg.id].nickname + " ";
				message.innerText = msg.msg;
				message.prepend(name);
				chatMessages.prepend(message);
			});
		</script>
		<script src="/waitingRoom.js"></script>
	</body>
</html>